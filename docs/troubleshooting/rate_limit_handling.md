# API请求频率限制处理指南

## 🔍 问题说明

当出现 **"Too Many Requests. Rate limited."** 错误时，表示API请求过于频繁，触发了频率限制。

## ✅ 已实现的解决方案

### 1. **自动重试机制**
- 检测到频率限制错误时，自动等待并重试
- 默认重试3次，每次等待时间递增（2秒、4秒、6秒）
- 重试过程中显示等待提示

### 2. **错误识别和处理**
- 自动识别频率限制错误
- 提供针对性的解决建议
- 区分不同类型的错误（频率限制 vs 数据不足 vs 其他错误）

### 3. **用户友好提示**
- 清晰的错误信息展示
- 详细的解决步骤
- 替代方案建议

## 🛠️ 使用建议

### 遇到频率限制时的操作

1. **立即操作**
   - 系统会自动重试（最多3次）
   - 等待自动重试完成
   - 如果自动重试失败，等待30秒-1分钟后手动重试

2. **避免频繁请求**
   - 不要连续多次点击"生成交易信号"
   - 两次请求之间至少间隔10-20秒
   - 使用缓存数据（系统会自动缓存）

3. **使用替代方案**
   - **多因子策略**：不依赖历史价格数据，可以使用已有的分析报告
   - **股票分析页面**：先在分析页面生成报告，然后使用报告数据

## 📊 API配额说明

### Tushare API限制

**免费账户：**
- 每分钟请求次数：有限制（根据账户等级）
- 每日请求次数：有限制
- 积分要求：部分接口需要积分

**建议：**
- 了解自己的API配额限制
- 合理规划请求频率
- 考虑升级到付费账户获取更高配额

## 🔄 系统行为

### 自动重试流程

```
请求API → 检测频率限制 → 等待2秒 → 重试1
     ↓
  仍然限制 → 等待4秒 → 重试2
     ↓
  仍然限制 → 等待6秒 → 重试3
     ↓
  仍然限制 → 显示错误提示
```

### 缓存机制

- 系统会缓存已获取的数据
- 相同股票的重复请求会使用缓存
- 缓存有效期：根据数据源配置
- 可以通过刷新页面清除缓存后重试

## 💡 最佳实践

### 1. **减少API调用**
```python
# 建议：批量处理多个股票
# 不推荐：逐个股票连续请求
```

### 2. **使用缓存**
- 先在其他页面（股票分析）获取数据
- 使用已缓存的数据
- 避免重复请求相同股票

### 3. **合理规划请求**
- 不要在短时间内请求大量股票
- 优先处理重要的股票
- 使用异步批量处理（未来功能）

### 4. **升级方案**
- 考虑使用付费API账户
- 配置多个API密钥轮换使用
- 使用本地数据缓存服务

## 🔧 技术实现

### 重试逻辑

```python
max_retries = 3
retry_delay = 2  # 初始等待时间

for attempt in range(max_retries):
    try:
        data = api_call()
        if "Rate limited" in data:
            if attempt < max_retries - 1:
                wait_time = retry_delay * (attempt + 1)
                time.sleep(wait_time)
                continue
        break
    except RateLimitError:
        # 处理频率限制错误
        ...
```

### 错误检测

```python
error_indicators = [
    "Too Many Requests",
    "Rate limited",
    "频率限制",
    "请求过于频繁"
]

if any(indicator in error_message for indicator in error_indicators):
    # 识别为频率限制错误
    handle_rate_limit()
```

## ⚠️ 注意事项

1. **不要过度依赖自动重试**
   - 如果持续遇到频率限制，应该停止请求
   - 等待更长时间后再重试

2. **检查API配置**
   - 确认API密钥正确
   - 检查账户状态和配额

3. **监控请求频率**
   - 记录请求次数
   - 避免超出配额限制

## 📞 技术支持

如果问题持续存在：
1. 检查API账户状态
2. 查看服务端日志了解详细错误
3. 考虑联系数据源提供商（Tushare）获取支持
