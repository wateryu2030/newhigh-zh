# 增强版A股数据下载（包含PE、PB等财务指标）

## 📋 问题说明

之前下载的数据中，PE（市盈率）、PB（市净率）等财务指标为`None`，导致智能选股功能无法正常使用。

## ✅ 解决方案

### 1. 修正列名映射

AKShare的`stock_zh_a_spot_em`接口返回的列名可能有多种变体：
- **市盈率**：可能是`"市盈率-动态"`、`"市盈率"`、`"动态市盈率"`等
- **市净率**：可能是`"市净率"`、`"PB"`等
- **市值**：可能是`"总市值"`、`"总市值(元)"`等

**改进**：使用多候选列名匹配机制，自动识别不同版本的列名。

### 2. 增强数据清洗

- **数值转换**：自动清理单位（如"元"、"万"）、逗号、空格
- **数据类型转换**：将字符串格式的数字转换为数值类型
- **空值处理**：对于缺失的列，自动添加并设为`None`

### 3. 数据完整性检查

下载完成后，自动检查关键字段的数据完整性：
- PE（市盈率）
- PB（市净率）
- 市值（总市值、流通市值）
- 价格

显示每个字段的数据覆盖率。

## 🔧 技术实现

### 列名映射逻辑

```python
mapping_candidates = {
    "pe": ["市盈率-动态", "市盈率", "PE", "动态市盈率", "pe", "pe_ttm"],
    "pb": ["市净率", "PB", "pb"],
    "market_cap": ["总市值", "总市值(元)", "market_cap", "total_mv"],
    # ... 更多映射
}

# 自动匹配第一个存在的列名
for new_col, candidates in mapping_candidates.items():
    for candidate in candidates:
        if candidate in available_columns:
            column_mapping[candidate] = new_col
            break
```

### 数值清洗

```python
# 清理单位、逗号、空格
df[col] = df[col].astype(str).str.replace('元', '').str.replace('万', '').str.replace(',', '').str.replace(' ', '')
df[col] = pd.to_numeric(df[col], errors="coerce")
```

## 📊 使用效果

### 改进前
- PE、PB等字段全为`None`
- 数据完整性：0%

### 改进后
- 自动识别并提取PE、PB等财务指标
- 显示数据完整性统计（如：PE数据覆盖率85%）
- 支持智能选股功能

## 🚀 使用方式

### Web界面
1. 打开"数据中心 - 基础资料"页面
2. 点击"下载/更新 A股基础资料"
3. 等待下载完成
4. 查看"数据完整性检查"的输出

### 命令行
```bash
python scripts/fetch_cn_stock_basic.py
```

## ⚠️ 注意事项

1. **网络稳定性**：下载5000+只股票数据需要1-3分钟，确保网络稳定
2. **数据源限制**：如果AKShare的数据源接口变化，可能需要更新列名映射
3. **降级机制**：如果实时数据获取失败，会自动降级到基础信息（代码+名称）

## 🔍 故障排查

### PE/PB仍为None
1. 检查下载日志，查看"实际获取到的列名"
2. 如果列名不匹配，可能需要更新`mapping_candidates`
3. 检查网络连接是否正常

### 数据不完整
1. 查看"数据完整性检查"的输出
2. 如果覆盖率很低（<50%），可能是数据源问题
3. 尝试重新下载或在非高峰时段下载

## 📝 后续优化

如果AKShare的实时数据接口仍然无法提供完整的PE/PB数据，可以考虑：
1. 使用`stock_individual_info_em`逐个获取（较慢但更完整）
2. 结合多个数据源（如东方财富、新浪财经等）
3. 使用计算方式：PE = 市值 / 净利润，PB = 市值 / 净资产

